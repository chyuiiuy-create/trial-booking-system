<!DOCTYPE html>
<html lang="zh-HK">
<!-- 
============================================
è©¦å ‚é ç´„ç³»çµ± - ç®¡ç†é ç´„é é¢ï¼ˆå–æ¶ˆ/æ›´æ”¹ï¼‰
============================================
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†é ç´„ - é¦™æ¸¯è³ªå¿ƒæ•™è‚²</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        .manage-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .manage-header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            margin-bottom: 24px;
        }
        .manage-header h1 { font-size: 24px; margin-bottom: 8px; }
        .manage-header p { font-size: 14px; opacity: 0.9; }
        
        .booking-info {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .booking-info h3 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .info-row { display: flex; padding: 8px 0; }
        .info-label { width: 100px; font-size: 13px; color: #7f8c8d; }
        .info-value { flex: 1; font-size: 14px; color: #2c3e50; font-weight: 500; }
        
        .action-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .action-section h3 { font-size: 16px; color: #2c3e50; margin-bottom: 16px; }
        
        .action-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .action-tab {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            transition: all 0.3s;
        }
        .action-tab:hover { border-color: #667eea; }
        .action-tab.active { border-color: #667eea; background: #f8f9ff; color: #667eea; font-weight: 600; }
        .action-tab.cancel.active { border-color: #e74c3c; background: #fef5f5; color: #e74c3c; }
        
        .action-content { display: none; }
        .action-content.active { display: block; }
        
        /* æ—¥æ›†æ¨£å¼ */
        .calendar-container { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
        .calendar { flex: 1; min-width: 240px; background: #f8f9fa; border-radius: 10px; padding: 12px; }
        .calendar-header { text-align: center; font-weight: 600; color: #2c3e50; padding: 8px; font-size: 14px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
        .calendar-day-header { text-align: center; font-size: 11px; color: #7f8c8d; padding: 4px 2px; }
        .calendar-day {
            text-align: center;
            padding: 8px 4px;
            font-size: 13px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .calendar-day:hover { background: #e8f4fd; }
        .calendar-day.selected { background: #667eea; color: white; }
        .calendar-day.disabled { color: #ccc; cursor: not-allowed; }
        .calendar-day.empty { cursor: default; }
        
        /* æ™‚é–“é¸æ“‡æ¨£å¼ */
        .time-selector { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px; }
        .time-option {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e0e0e0;
        }
        .time-option:hover { background: #e8f4fd; border-color: #667eea; }
        .time-option.selected { background: #667eea; color: white; border-color: #667eea; }
        
        .add-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
        }
        .add-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .selected-list { background: #e8f5e9; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
        .selected-list h4 { font-size: 13px; color: #27ae60; margin-bottom: 8px; }
        .selected-items { display: flex; flex-wrap: wrap; gap: 6px; }
        .selected-item {
            background: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #c3e6cb;
        }
        .selected-item .remove { cursor: pointer; color: #e74c3c; font-weight: bold; }
        
        .submit-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .submit-btn.change { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .submit-btn.cancel { background: #e74c3c; color: white; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #856404;
        }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; color: #666; margin-bottom: 6px; }
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            min-height: 80px;
            resize: vertical;
        }
        .form-textarea:focus { border-color: #667eea; outline: none; }
        
        .success-box, .error-box {
            display: none;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
        }
        .success-box { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .success-box.active, .error-box.active { display: block; }
        .error-box { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        
        .footer {
            text-align: center;
            padding: 20px;
            font-size: 12px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="manage-container">
        <div class="manage-header">
            <h1>ğŸ“… ç®¡ç†æ‚¨çš„é ç´„</h1>
            <p>é¦™æ¸¯è³ªå¿ƒæ•™è‚²</p>
        </div>
        
        <!-- é ç´„è³‡è¨Š -->
        <div class="booking-info" id="booking-info">
            <h3>ğŸ“‹ æ‚¨çš„é ç´„è³‡è¨Š</h3>
            <div class="info-row">
                <span class="info-label">å­¸ç”Ÿå§“å</span>
                <span class="info-value" id="info-name">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="info-row">
                <span class="info-label">ç¢ºèªæ—¥æœŸ</span>
                <span class="info-value" id="info-date">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="info-row">
                <span class="info-label">ç¢ºèªæ™‚é–“</span>
                <span class="info-value" id="info-time">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="info-row">
                <span class="info-label">ç§‘ç›®</span>
                <span class="info-value" id="info-subject">è¼‰å…¥ä¸­...</span>
            </div>
        </div>
        
        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div class="error-box" id="error-box">
            <p>âš ï¸ ç„¡æ³•è¼‰å…¥é ç´„è³‡è¨Š</p>
            <p style="font-size: 12px; margin-top: 8px;">è«‹ç¢ºèªæ‚¨çš„é€£çµæ˜¯å¦æ­£ç¢ºï¼Œæˆ–è¯çµ¡æˆ‘å€‘ï¼š5765 1008</p>
        </div>
        
        <!-- æˆåŠŸè¨Šæ¯ -->
        <div class="success-box" id="success-box">
            <h3 id="success-title">âœ… æäº¤æˆåŠŸ</h3>
            <p id="success-message">æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„ç”³è«‹ï¼Œå°‡ç›¡å¿«è™•ç†ã€‚</p>
            <p style="margin-top: 12px; font-size: 13px;">å¦‚æœ‰ç–‘å•ï¼Œè«‹è‡´é›»ï¼š5765 1008</p>
        </div>
        
        <!-- æ“ä½œå€åŸŸ -->
        <div class="action-section" id="action-section">
            <h3>âœï¸ é¸æ“‡æ“ä½œ</h3>
            
            <div class="action-tabs">
                <div class="action-tab active" onclick="switchTab('change')">ğŸ”„ æ›´æ”¹é ç´„</div>
                <div class="action-tab cancel" onclick="switchTab('cancel')">âŒ å–æ¶ˆé ç´„</div>
            </div>
            
            <!-- æ›´æ”¹é ç´„è¡¨å–® -->
            <div class="action-content active" id="change-content">
                <p style="font-size: 13px; color: #666; margin-bottom: 16px;">
                    è«‹é¸æ“‡æ–°çš„æ—¥æœŸå’Œæ™‚é–“ï¼ˆå¯å¤šé¸ï¼‰ï¼š
                </p>
                
                <!-- æ—¥æ›†é¸æ“‡ -->
                <div class="calendar-container" id="calendar-container"></div>
                
                <!-- æ™‚é–“é¸æ“‡ -->
                <h4 style="font-size: 14px; color: #2c3e50; margin-bottom: 10px;">é¸æ“‡æ™‚é–“æ®µï¼š</h4>
                <div class="time-selector" id="time-selector"></div>
                
                <!-- åŠ å…¥æŒ‰éˆ• -->
                <button class="add-btn" id="add-btn" onclick="addToList()" disabled>
                    â• åŠ å…¥åˆ°å¯ç”¨æ—¥æœŸåˆ—è¡¨
                </button>
                
                <!-- å·²é¸åˆ—è¡¨ -->
                <div class="selected-list" id="selected-list" style="display: none;">
                    <h4>âœ… å·²é¸æ“‡çš„æ—¥æœŸæ™‚æ®µï¼š</h4>
                    <div class="selected-items" id="selected-items"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">å‚™è¨»ï¼ˆå¯é¸ï¼‰</label>
                    <textarea class="form-textarea" id="change-notes" placeholder="å¦‚æœ‰å…¶ä»–éœ€è¦èªªæ˜çš„äº‹é …..."></textarea>
                </div>
                
                <button class="submit-btn change" id="change-btn" onclick="submitChange()">
                    ç¢ºèªæ›´æ”¹é ç´„
                </button>
            </div>
            
            <!-- å–æ¶ˆé ç´„è¡¨å–® -->
            <div class="action-content" id="cancel-content">
                <div class="warning-box">
                    âš ï¸ å–æ¶ˆé ç´„å¾Œï¼Œæ‚¨éœ€è¦é‡æ–°é ç´„æ‰èƒ½å®‰æ’è©¦å ‚ã€‚
                </div>
                <div class="form-group">
                    <label class="form-label">å–æ¶ˆåŸå› ï¼ˆå¯é¸ï¼‰</label>
                    <textarea class="form-textarea" id="cancel-reason" placeholder="è«‹å‘Šè¨´æˆ‘å€‘å–æ¶ˆçš„åŸå› ..."></textarea>
                </div>
                <button class="submit-btn cancel" onclick="submitCancel()">
                    ç¢ºèªå–æ¶ˆé ç´„
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p>ğŸ“ ä¹é¾å¤ªå­å½Œæ•¦é“761è™Ÿå¤ªå­è—é¦¬ä¹‹åŸ3æ¨“Bå®¤</p>
            <p>ğŸ“ 5765 1008</p>
            <p style="margin-top: 10px;">&copy; 2024 é¦™æ¸¯è³ªå¿ƒæ•™è‚² ç‰ˆæ¬Šæ‰€æœ‰</p>
        </div>
    </div>
    
    <script>
        // Google Apps Script URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzW4sqzfRtVPE9Bf-SWsE06Ozouvd4YllT6o82AXoFN6MktZYzdUNk07TQ-bxABwy6kPQ/exec';
        
        // å¾ URL åƒæ•¸ç²å–é ç´„ä¿¡æ¯
        const urlParams = new URLSearchParams(window.location.search);
        const bookingId = urlParams.get('id');
        const studentName = urlParams.get('name');
        const confirmedDate = urlParams.get('date');
        const confirmedTime = urlParams.get('time');
        const subject = urlParams.get('subject');
        
        // æ—¥æ›†å’Œæ™‚é–“é¸æ“‡
        const WEEKDAYS = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const TIME_SLOTS = [];
        
        // ç”Ÿæˆæ™‚é–“æ®µï¼ˆ10:00-21:00ï¼Œ30åˆ†é˜é–“éš”ï¼‰
        for (let h = 10; h <= 20; h++) {
            TIME_SLOTS.push(`${h}:00-${h+1}:00`);
            if (h < 20) {
                TIME_SLOTS.push(`${h}:30-${h+1}:30`);
            }
        }
        TIME_SLOTS.push('20:30-21:00');
        
        let selectedDates = [];
        let selectedTimes = [];
        let selectedList = [];
        
        // åˆå§‹åŒ–é é¢
        document.addEventListener('DOMContentLoaded', function() {
            if (!bookingId || !studentName) {
                document.getElementById('booking-info').style.display = 'none';
                document.getElementById('action-section').style.display = 'none';
                document.getElementById('error-box').classList.add('active');
                return;
            }
            
            // é¡¯ç¤ºé ç´„ä¿¡æ¯
            document.getElementById('info-name').textContent = decodeURIComponent(studentName);
            document.getElementById('info-date').textContent = decodeURIComponent(confirmedDate || 'æœªç¢ºèª');
            document.getElementById('info-time').textContent = decodeURIComponent(confirmedTime || 'æœªç¢ºèª');
            document.getElementById('info-subject').textContent = decodeURIComponent(subject || 'æœªæŒ‡å®š');
            
            // åˆå§‹åŒ–æ—¥æ›†å’Œæ™‚é–“é¸æ“‡
            renderCalendars();
            renderTimeSelector();
        });
        
        // æ¸²æŸ“æ—¥æ›†
        function renderCalendars() {
            const container = document.getElementById('calendar-container');
            const today = new Date();
            
            let html = '';
            for (let m = 0; m < 2; m++) {
                const date = new Date(today.getFullYear(), today.getMonth() + m, 1);
                html += renderMonth(date, today);
            }
            container.innerHTML = html;
        }
        
        function renderMonth(date, today) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let html = `<div class="calendar">
                <div class="calendar-header">${year}å¹´${month + 1}æœˆ</div>
                <div class="calendar-grid">`;
            
            WEEKDAYS.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            for (let i = 0; i < firstDay; i++) {
                html += `<div class="calendar-day empty"></div>`;
            }
            
            for (let d = 1; d <= daysInMonth; d++) {
                const cellDate = new Date(year, month, d);
                const dateStr = `${month + 1}æœˆ${d}æ—¥`;
                const isPast = cellDate < new Date(today.getFullYear(), today.getMonth(), today.getDate());
                
                if (isPast) {
                    html += `<div class="calendar-day disabled">${d}</div>`;
                } else {
                    html += `<div class="calendar-day" data-date="${dateStr}" onclick="toggleDate('${dateStr}', this)">${d}</div>`;
                }
            }
            
            html += `</div></div>`;
            return html;
        }
        
        function toggleDate(dateStr, el) {
            const index = selectedDates.indexOf(dateStr);
            if (index > -1) {
                selectedDates.splice(index, 1);
                el.classList.remove('selected');
            } else {
                selectedDates.push(dateStr);
                el.classList.add('selected');
            }
            updateAddButton();
        }
        
        // æ¸²æŸ“æ™‚é–“é¸æ“‡å™¨
        function renderTimeSelector() {
            const container = document.getElementById('time-selector');
            container.innerHTML = TIME_SLOTS.map(slot => 
                `<div class="time-option" data-time="${slot}" onclick="toggleTime('${slot}', this)">${slot}</div>`
            ).join('');
        }
        
        function toggleTime(timeStr, el) {
            const index = selectedTimes.indexOf(timeStr);
            if (index > -1) {
                selectedTimes.splice(index, 1);
                el.classList.remove('selected');
            } else {
                selectedTimes.push(timeStr);
                el.classList.add('selected');
            }
            updateAddButton();
        }
        
        function updateAddButton() {
            document.getElementById('add-btn').disabled = selectedDates.length === 0 || selectedTimes.length === 0;
        }
        
        function addToList() {
            if (selectedDates.length === 0 || selectedTimes.length === 0) return;
            
            // æª¢æŸ¥æ˜¯å¦è¶…é10å€‹
            let newCombos = [];
            selectedDates.forEach(date => {
                selectedTimes.forEach(time => {
                    const combo = `${date} ${time}`;
                    if (!selectedList.includes(combo)) {
                        newCombos.push(combo);
                    }
                });
            });
            
            if (selectedList.length + newCombos.length > 10) {
                alert('âš ï¸ é ç´„æ™‚æ®µä¸èƒ½è¶…é10å€‹ï¼');
                return;
            }
            
            newCombos.forEach(combo => selectedList.push(combo));
            
            // æ¸…ç©ºé¸æ“‡
            selectedDates = [];
            selectedTimes = [];
            document.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.time-option.selected').forEach(el => el.classList.remove('selected'));
            
            renderSelectedList();
            updateAddButton();
        }
        
        function renderSelectedList() {
            const container = document.getElementById('selected-list');
            const itemsContainer = document.getElementById('selected-items');
            
            if (selectedList.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            itemsContainer.innerHTML = selectedList.map((item, index) => 
                `<div class="selected-item">
                    <span>${item}</span>
                    <span class="remove" onclick="removeFromList(${index})">âœ•</span>
                </div>`
            ).join('');
        }
        
        function removeFromList(index) {
            selectedList.splice(index, 1);
            renderSelectedList();
        }
        
        // åˆ‡æ›æ¨™ç±¤
        function switchTab(tab) {
            document.querySelectorAll('.action-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.action-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'change') {
                document.querySelector('.action-tab:first-child').classList.add('active');
                document.getElementById('change-content').classList.add('active');
            } else {
                document.querySelector('.action-tab.cancel').classList.add('active');
                document.getElementById('cancel-content').classList.add('active');
            }
        }
        
        // æäº¤æ›´æ”¹
        function submitChange() {
            if (selectedList.length === 0) {
                alert('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹æ–°çš„æ—¥æœŸå’Œæ™‚é–“');
                return;
            }
            
            const notes = document.getElementById('change-notes').value.trim();
            const btn = document.getElementById('change-btn');
            btn.disabled = true;
            btn.textContent = 'è™•ç†ä¸­...';
            
            const data = {
                action: 'updateBooking',
                type: 'change',
                originalId: bookingId,
                studentName: decodeURIComponent(studentName),
                originalDate: decodeURIComponent(confirmedDate || ''),
                originalTime: decodeURIComponent(confirmedTime || ''),
                newPreferredDate: selectedList.join('; '),
                notes: notes,
                timestamp: new Date().toLocaleString('zh-HK')
            };
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(() => {
                showSuccess('æ›´æ”¹ç”³è«‹å·²æäº¤', 'æ‚¨çš„åŸé ç´„å·²æ¨™è¨˜ç‚ºã€Œæ›´æ”¹ä¸­ã€ï¼Œæˆ‘å€‘å°‡æ ¹æ“šæ‚¨é¸æ“‡çš„æ–°æ™‚æ®µé‡æ–°å®‰æ’ï¼Œä¸¦ä»¥é›»éƒµé€šçŸ¥æ‚¨ã€‚');
            }).catch(err => {
                console.error(err);
                showSuccess('æ›´æ”¹ç”³è«‹å·²æäº¤', 'æ‚¨çš„åŸé ç´„å·²æ¨™è¨˜ç‚ºã€Œæ›´æ”¹ä¸­ã€ï¼Œæˆ‘å€‘å°‡æ ¹æ“šæ‚¨é¸æ“‡çš„æ–°æ™‚æ®µé‡æ–°å®‰æ’ï¼Œä¸¦ä»¥é›»éƒµé€šçŸ¥æ‚¨ã€‚');
            });
        }
        
        // æäº¤å–æ¶ˆ
        function submitCancel() {
            if (!confirm('ç¢ºå®šè¦å–æ¶ˆé ç´„å—ï¼Ÿ')) return;
            
            const reason = document.getElementById('cancel-reason').value.trim();
            const btn = document.querySelector('.submit-btn.cancel');
            btn.disabled = true;
            btn.textContent = 'è™•ç†ä¸­...';
            
            const data = {
                action: 'updateBooking',
                type: 'cancel',
                originalId: bookingId,
                studentName: decodeURIComponent(studentName),
                cancelDate: decodeURIComponent(confirmedDate || ''),
                cancelTime: decodeURIComponent(confirmedTime || ''),
                reason: reason,
                timestamp: new Date().toLocaleString('zh-HK')
            };
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(() => {
                showSuccess('å–æ¶ˆç”³è«‹å·²ç¢ºèª', 'æ‚¨çš„é ç´„å·²è¢«å–æ¶ˆã€‚å¦‚éœ€é‡æ–°é ç´„ï¼Œè«‹è¨ªå•æˆ‘å€‘çš„ç¶²ç«™ã€‚');
            }).catch(err => {
                console.error(err);
                showSuccess('å–æ¶ˆç”³è«‹å·²ç¢ºèª', 'æ‚¨çš„é ç´„å·²è¢«å–æ¶ˆã€‚å¦‚éœ€é‡æ–°é ç´„ï¼Œè«‹è¨ªå•æˆ‘å€‘çš„ç¶²ç«™ã€‚');
            });
        }
        
        function showSuccess(title, message) {
            document.getElementById('booking-info').style.display = 'none';
            document.getElementById('action-section').style.display = 'none';
            document.getElementById('success-title').textContent = 'âœ… ' + title;
            document.getElementById('success-message').textContent = message;
            document.getElementById('success-box').classList.add('active');
        }
    </script>
</body>
</html>
